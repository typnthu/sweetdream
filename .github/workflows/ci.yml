name: CI

on:
  push:
    branches: [master, dev]
  pull_request:
    branches: [master, dev]

env:
  NODE_VERSION: '20'

permissions:
  contents: read
  pull-requests: write

jobs:
  # Detect what changed to run only necessary jobs
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      order-service: ${{ steps.filter.outputs.order-service }}
      user-service: ${{ steps.filter.outputs.user-service }}
      terraform: ${{ steps.filter.outputs.terraform }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'be/**'
            frontend:
              - 'fe/**'
            order-service:
              - 'order-service/**'
            user-service:
              - 'user-service/**'
            terraform:
              - 'terraform/**'

  # Backend CI
  backend:
    name: Backend
    needs: changes
    if: needs.changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: sweetdream_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: be/package-lock.json
      
      - name: Install & Build
        working-directory: be
        run: |
          npm ci
          npx prisma generate
          npm run build
      
      - name: Lint
        working-directory: be
        run: npm run lint
        continue-on-error: true
      
      - name: Run Tests
        working-directory: be
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/sweetdream_test
        run: |
          npx prisma migrate deploy
          npm test
      
      - name: Security Audit
        working-directory: be
        run: npm audit --audit-level=moderate
        continue-on-error: true

  # Frontend CI
  frontend:
    name: Frontend
    needs: changes
    if: needs.changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: fe/package-lock.json
      
      - name: Install & Build
        working-directory: fe
        env:
          NEXT_PUBLIC_API_URL: http://localhost:3001
        run: |
          npm ci
          npm run build
      
      - name: Lint
        working-directory: fe
        run: npm run lint
        continue-on-error: true
      
      - name: Type Check
        working-directory: fe
        run: npx tsc --noEmit
        continue-on-error: true
      
      - name: Security Audit
        working-directory: fe
        run: npm audit --audit-level=moderate
        continue-on-error: true

  # Order Service CI
  order-service:
    name: Order Service
    needs: changes
    if: needs.changes.outputs.order-service == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: order-service/package-lock.json
      
      - name: Install & Build
        working-directory: order-service
        run: |
          npm ci
          npx prisma generate
          npm run build

  # User Service CI
  user-service:
    name: User Service
    needs: changes
    if: needs.changes.outputs.user-service == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: user-service/package-lock.json
      
      - name: Install & Build
        working-directory: user-service
        run: |
          npm ci
          npx prisma generate
          npm run build

  # Terraform Check
  terraform:
    name: Terraform
    needs: changes
    if: needs.changes.outputs.terraform == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
      
      - name: Format Check
        working-directory: terraform
        run: terraform fmt -check -recursive
      
      - name: Validate
        working-directory: terraform
        run: |
          terraform init -backend=false
          terraform validate

  # Summary
  summary:
    name: CI Summary
    needs: [changes, backend, frontend, order-service, user-service, terraform]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Summary
        run: |
          echo "## CI Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Changed | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.changes.outputs.backend }} | ${{ needs.backend.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.changes.outputs.frontend }} | ${{ needs.frontend.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Order Service | ${{ needs.changes.outputs.order-service }} | ${{ needs.order-service.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| User Service | ${{ needs.changes.outputs.user-service }} | ${{ needs.user-service.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform | ${{ needs.changes.outputs.terraform }} | ${{ needs.terraform.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
