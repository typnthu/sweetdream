name: Optimized Deploy (Smart Terraform + App)

on:
  push:
    branches:
      - dev
      - main
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  TF_VERSION: 1.6.0
  ECS_CLUSTER: sweetdream-cluster

jobs:
  # Detect what changed
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      terraform: ${{ steps.filter.outputs.terraform }}
      application: ${{ steps.filter.outputs.application }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Detect changed paths
        uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            terraform:
              - 'terraform/**'
            application:
              - 'be/**'
              - 'fe/**'
              - 'order-service/**'
              - 'user-service/**'
              - '.github/workflows/deploy-optimized.yml'

  # Deploy infrastructure ONLY if terraform files changed
  deploy-infrastructure:
    name: Deploy Infrastructure
    needs: detect-changes
    if: needs.detect-changes.outputs.terraform == 'true'
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}
    defaults:
      run:
        working-directory: terraform
    outputs:
      alb_url: ${{ steps.outputs.outputs.alb_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      - name: Terraform Init
        run: terraform init
      
      - name: Terraform Plan
        run: terraform plan -out=tfplan -var="db_password=${{ secrets.DB_PASSWORD }}"
      
      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan
      
      - name: Save Outputs
        id: outputs
        run: |
          echo "alb_url=$(terraform output -raw alb_url)" >> $GITHUB_OUTPUT
          echo "âœ… Infrastructure deployed!" >> $GITHUB_STEP_SUMMARY

  # Build and push Docker images (ONLY if application changed)
  build-images:
    name: Build & Push Images
    needs: [detect-changes, deploy-infrastructure]
    if: always() && needs.detect-changes.outputs.application == 'true'
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Login to ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Get ALB URL
        id: get-alb
        run: |
          ALB_URL=$(aws elbv2 describe-load-balancers --query 'LoadBalancers[?contains(LoadBalancerName, `sweetdream`)].DNSName' --output text)
          echo "alb_url=$ALB_URL" >> $GITHUB_OUTPUT
      
      - name: Build and Push Backend
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          cd be
          docker build -t $ECR_REGISTRY/sweetdream-backend:$IMAGE_TAG .
          docker tag $ECR_REGISTRY/sweetdream-backend:$IMAGE_TAG $ECR_REGISTRY/sweetdream-backend:latest
          docker push $ECR_REGISTRY/sweetdream-backend:$IMAGE_TAG
          docker push $ECR_REGISTRY/sweetdream-backend:latest
      
      - name: Build and Push Frontend
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
          NEXT_PUBLIC_API_URL: http://${{ steps.get-alb.outputs.alb_url }}
        run: |
          cd fe
          docker build --build-arg NEXT_PUBLIC_API_URL=$NEXT_PUBLIC_API_URL -t $ECR_REGISTRY/sweetdream-frontend:$IMAGE_TAG .
          docker tag $ECR_REGISTRY/sweetdream-frontend:$IMAGE_TAG $ECR_REGISTRY/sweetdream-frontend:latest
          docker push $ECR_REGISTRY/sweetdream-frontend:$IMAGE_TAG
          docker push $ECR_REGISTRY/sweetdream-frontend:latest
      
      - name: Build and Push Order Service
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          cd order-service
          docker build -t $ECR_REGISTRY/sweetdream-order-service:$IMAGE_TAG .
          docker tag $ECR_REGISTRY/sweetdream-order-service:$IMAGE_TAG $ECR_REGISTRY/sweetdream-order-service:latest
          docker push $ECR_REGISTRY/sweetdream-order-service:$IMAGE_TAG
          docker push $ECR_REGISTRY/sweetdream-order-service:latest
      
      - name: Build and Push User Service
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          cd user-service
          docker build -t $ECR_REGISTRY/sweetdream-user-service:$IMAGE_TAG .
          docker tag $ECR_REGISTRY/sweetdream-user-service:$IMAGE_TAG $ECR_REGISTRY/sweetdream-user-service:latest
          docker push $ECR_REGISTRY/sweetdream-user-service:$IMAGE_TAG
          docker push $ECR_REGISTRY/sweetdream-user-service:latest

  # Deploy to ECS (ONLY if application changed)
  deploy-application:
    name: Deploy to ECS
    needs: [detect-changes, build-images]
    if: always() && needs.detect-changes.outputs.application == 'true'
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}
    steps:
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Force new deployment for all services
        run: |
          echo "ðŸš€ Deploying all services..."
          aws ecs update-service --cluster ${{ env.ECS_CLUSTER }} --service sweetdream-backend --force-new-deployment
          aws ecs update-service --cluster ${{ env.ECS_CLUSTER }} --service sweetdream-frontend --force-new-deployment
          aws ecs update-service --cluster ${{ env.ECS_CLUSTER }} --service sweetdream-order-service --force-new-deployment
          aws ecs update-service --cluster ${{ env.ECS_CLUSTER }} --service sweetdream-user-service --force-new-deployment
      
      - name: Wait for services to stabilize
        run: |
          echo "â³ Waiting for services to stabilize..."
          aws ecs wait services-stable --cluster ${{ env.ECS_CLUSTER }} --services sweetdream-backend sweetdream-frontend sweetdream-order-service sweetdream-user-service
          echo "âœ… All services are stable!"

  # Summary
  deployment-summary:
    name: Deployment Summary
    needs: [detect-changes, deploy-infrastructure, deploy-application]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Get deployment info
        id: info
        run: |
          ALB_URL=$(aws elbv2 describe-load-balancers --query 'LoadBalancers[?contains(LoadBalancerName, `sweetdream`)].DNSName' --output text)
          echo "alb_url=$ALB_URL" >> $GITHUB_OUTPUT
      
      - name: Create summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š What Was Deployed" >> $GITHUB_STEP_SUMMARY
          echo "- **Terraform Changed**: ${{ needs.detect-changes.outputs.terraform }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Application Changed**: ${{ needs.detect-changes.outputs.application }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Results" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.detect-changes.outputs.terraform }}" == "true" ]; then
            echo "- âœ… Infrastructure: ${{ needs.deploy-infrastructure.result }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- â­ï¸ Infrastructure: Skipped (no changes)" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.detect-changes.outputs.application }}" == "true" ]; then
            echo "- âœ… Application: ${{ needs.deploy-application.result }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- â­ï¸ Application: Skipped (no changes)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ Access" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: http://${{ steps.info.outputs.alb_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
