name: Deploy to AWS

on:
  push:
    branches: [master, dev]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - production
          - development
        default: 'development'
      force_deploy:
        description: 'Force deploy all services (ignore change detection)'
        type: boolean
        default: false

env:
  AWS_REGION: us-east-1
  ECS_CLUSTER: sweetdream-cluster
  TERRAFORM_VERSION: '1.6.0'

permissions:
  contents: read
  id-token: write

jobs:
  # Detect changes
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      order-service: ${{ steps.filter.outputs.order-service }}
      user-service: ${{ steps.filter.outputs.user-service }}
      terraform: ${{ steps.filter.outputs.terraform }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'be/**'
            frontend:
              - 'fe/**'
            order-service:
              - 'order-service/**'
            user-service:
              - 'user-service/**'
            terraform:
              - 'terraform/**'

  # Deploy infrastructure
  deploy-infrastructure:
    name: Deploy Infrastructure
    needs: changes
    if: needs.changes.outputs.terraform == 'true' || github.event.inputs.force_deploy == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 45
    environment: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/master' && 'production' || 'development') }}
    defaults:
      run:
        working-directory: terraform
    steps:
      - uses: actions/checkout@v4
      
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Terraform Init
        run: terraform init
      
      - name: Terraform Validate
        run: terraform validate
      
      - name: Terraform Plan
        run: |
          terraform plan \
            -var="db_password=${{ secrets.DB_PASSWORD }}" \
            -var="db_username=${{ secrets.DB_USERNAME || 'postgres' }}" \
            -var="alert_email=${{ secrets.ALERT_EMAIL || 'admin@example.com' }}" \
            -var="enable_customer_analytics=${{ vars.ENABLE_ANALYTICS || 'false' }}" \
            -var="log_retention_days=${{ vars.LOG_RETENTION_DAYS || '7' }}" \
            -var="analytics_bucket_prefix=${{ vars.ANALYTICS_BUCKET_PREFIX || 'sweetdream-analytics' }}" \
            -out=tfplan
      
      - name: Terraform Apply
        run: |
          terraform apply -auto-approve tfplan
          
          echo "## Infrastructure Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo " VPC, ECS Cluster, RDS, ALB, and all modules deployed" >> $GITHUB_STEP_SUMMARY

  # Build and deploy services
  deploy-services:
    name: Deploy Services
    needs: [changes, deploy-infrastructure]
    if: |
      always() && !cancelled() &&
      (needs.deploy-infrastructure.result == 'success' || needs.deploy-infrastructure.result == 'skipped') &&
      (needs.changes.outputs.backend == 'true' || 
       needs.changes.outputs.frontend == 'true' || 
       needs.changes.outputs.order-service == 'true' || 
       needs.changes.outputs.user-service == 'true' ||
       github.event.inputs.force_deploy == 'true')
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/master' && 'production' || 'development') }}
    strategy:
      matrix:
        service:
          - name: backend
            path: be
            port: 3001
            changed: ${{ needs.changes.outputs.backend }}
          - name: frontend
            path: fe
            port: 3000
            changed: ${{ needs.changes.outputs.frontend }}
          - name: order-service
            path: order-service
            port: 3002
            changed: ${{ needs.changes.outputs.order-service }}
          - name: user-service
            path: user-service
            port: 3003
            changed: ${{ needs.changes.outputs.user-service }}
      fail-fast: false
    steps:
      - name: Check if deployment needed
        id: check
        run: |
          if [[ "${{ matrix.service.changed }}" == "true" || "${{ github.event.inputs.force_deploy }}" == "true" ]]; then
            echo "deploy=true" >> $GITHUB_OUTPUT
            echo " Deploying ${{ matrix.service.name }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "deploy=false" >> $GITHUB_OUTPUT
            echo " Skipping ${{ matrix.service.name }} (no changes)" >> $GITHUB_STEP_SUMMARY
          fi
      
      - uses: actions/checkout@v4
        if: steps.check.outputs.deploy == 'true'
      
      - uses: aws-actions/configure-aws-credentials@v4
        if: steps.check.outputs.deploy == 'true'
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - uses: aws-actions/amazon-ecr-login@v2
        if: steps.check.outputs.deploy == 'true'
        id: ecr
      
      - name: Get ALB URL
        if: steps.check.outputs.deploy == 'true' && matrix.service.name == 'frontend'
        id: alb
        run: |
          ALB_URL=$(aws elbv2 describe-load-balancers \
            --query 'LoadBalancers[?contains(LoadBalancerName, `sweetdream`)].DNSName' \
            --output text)
          echo "url=$ALB_URL" >> $GITHUB_OUTPUT
      
      - name: Build & Push Docker Image
        if: steps.check.outputs.deploy == 'true'
        env:
          ECR_REGISTRY: ${{ steps.ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          IMAGE_NAME=$ECR_REGISTRY/sweetdream-${{ matrix.service.name }}
          
          # Build with appropriate args
          if [[ "${{ matrix.service.name }}" == "frontend" ]]; then
            docker build \
              --build-arg NEXT_PUBLIC_API_URL=http://${{ steps.alb.outputs.url }} \
              -t $IMAGE_NAME:latest \
              -t $IMAGE_NAME:$IMAGE_TAG \
              ./${{ matrix.service.path }}
          else
            docker build \
              -t $IMAGE_NAME:latest \
              -t $IMAGE_NAME:$IMAGE_TAG \
              ./${{ matrix.service.path }}
          fi
          
          # Push both tags
          docker push $IMAGE_NAME:latest
          docker push $IMAGE_NAME:$IMAGE_TAG
          
          echo "âœ… Pushed ${{ matrix.service.name }}:$IMAGE_TAG" >> $GITHUB_STEP_SUMMARY
      
      - name: Update Task Definition with New Image
        if: steps.check.outputs.deploy == 'true'
        id: task-def
        env:
          ECR_REGISTRY: ${{ steps.ecr.outputs.registry }}
        run: |
          TASK_FAMILY="sweetdream-task-${{ matrix.service.name }}"
          IMAGE_NAME=$ECR_REGISTRY/sweetdream-${{ matrix.service.name }}:latest
          
          # Get current task definition and update image
          TASK_DEF=$(aws ecs describe-task-definition --task-definition $TASK_FAMILY --query 'taskDefinition')
          
          # Update image and clean up AWS-managed fields
          NEW_TASK_DEF=$(echo $TASK_DEF | jq --arg IMAGE "$IMAGE_NAME" '
            .containerDefinitions[0].image = $IMAGE |
            del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)
          ')
          
          # Register new task definition and capture the ARN
          NEW_TASK_ARN=$(aws ecs register-task-definition --cli-input-json "$NEW_TASK_DEF" | jq -r '.taskDefinition.taskDefinitionArn')
          
          echo "task_arn=$NEW_TASK_ARN" >> $GITHUB_OUTPUT
          echo "âœ… Registered new task definition: $NEW_TASK_ARN" >> $GITHUB_STEP_SUMMARY
      
      - name: Update ECS Service with New Task Definition
        if: steps.check.outputs.deploy == 'true'
        run: |
          SERVICE_NAME="sweetdream-service-${{ matrix.service.name }}"
          
          echo "ðŸš€ Updating $SERVICE_NAME to use new task definition..."
          
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service $SERVICE_NAME \
            --task-definition ${{ steps.task-def.outputs.task_arn }} \
            --force-new-deployment \
            --no-cli-pager
          
          echo "âœ… $SERVICE_NAME updated with new task definition" >> $GITHUB_STEP_SUMMARY
      
      - name: Wait for deployment
        if: steps.check.outputs.deploy == 'true'
        run: |
          SERVICE_NAME="sweetdream-service-${{ matrix.service.name }}"
          
          echo "â³ Waiting for $SERVICE_NAME to stabilize..."
          
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services $SERVICE_NAME \
            --no-cli-pager
          
          echo "âœ… $SERVICE_NAME is stable" >> $GITHUB_STEP_SUMMARY

  # Deployment summary
  summary:
    name: Deployment Summary
    needs: [changes, deploy-infrastructure, deploy-services]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Get Deployment Info
        id: info
        run: |
          ALB_URL=$(aws elbv2 describe-load-balancers \
            --query 'LoadBalancers[?contains(LoadBalancerName, `sweetdream`)].DNSName' \
            --output text)
          echo "alb_url=$ALB_URL" >> $GITHUB_OUTPUT
          
          # Get service statuses
          SERVICES=("backend" "frontend" "order-service" "user-service")
          for service in "${SERVICES[@]}"; do
            STATUS=$(aws ecs describe-services \
              --cluster ${{ env.ECS_CLUSTER }} \
              --services sweetdream-service-$service \
              --query 'services[0].deployments[0].rolloutState' \
              --output text 2>/dev/null || echo "NOT_FOUND")
            echo "${service}_status=$STATUS" >> $GITHUB_OUTPUT
          done
      
      - name: Create Summary
        run: |
          echo "##Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "###Status" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Infrastructure | ${{ needs.deploy-infrastructure.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ steps.info.outputs.backend_status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ steps.info.outputs.frontend_status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Order Service | ${{ steps.info.outputs.order-service_status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| User Service | ${{ steps.info.outputs.user-service_status }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Access" >> $GITHUB_STEP_SUMMARY
          echo "- **Application URL**: http://${{ steps.info.outputs.alb_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/master' && 'production' || 'development') }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Changes Deployed" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: ${{ needs.changes.outputs.backend == 'true' && 'âœ…' || 'â­ï¸' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: ${{ needs.changes.outputs.frontend == 'true' && 'âœ…' || 'â­ï¸' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Order Service: ${{ needs.changes.outputs.order-service == 'true' && 'âœ…' || 'â­ï¸' }}" >> $GITHUB_STEP_SUMMARY
          echo "- User Service: ${{ needs.changes.outputs.user-service == 'true' && 'âœ…' || 'â­ï¸' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Terraform: ${{ needs.changes.outputs.terraform == 'true' && 'âœ…' || 'â­ï¸' }}" >> $GITHUB_STEP_SUMMARY

