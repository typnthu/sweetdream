name: Deploy

on:
  push:
    branches: [main, master, dev]
  workflow_dispatch:
    inputs:
      destroy_first:
        description: 'Destroy all resources first (clean slate)'
        type: boolean
        default: false

env:
  AWS_REGION: us-east-1
  ECS_CLUSTER: sweetdream-cluster

jobs:

  # Deploy everything
  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    timeout-minutes: 45
    environment: ${{ (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && 'production' || 'development' }}
    defaults:
      run:
        working-directory: terraform
    steps:
      - uses: actions/checkout@v4
      
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
      
      - name: Remove Remote State (Fresh Start)
        if: contains(github.event.head_commit.message, '[fresh-state]')
        run: |
          echo "âš ï¸ Removing remote Terraform state for fresh deployment..."
          aws s3 rm s3://sweetdream-terraform-state-409964509537/terraform.tfstate || true
          
          echo "Clearing DynamoDB lock and digest..."
          aws dynamodb delete-item \
            --table-name sweetdream-terraform-locks \
            --key '{"LockID":{"S":"sweetdream-terraform-state-409964509537/terraform.tfstate-md5"}}' || true
          
          echo "âœ“ State and locks cleared"
      
      - name: Terraform Init
        run: terraform init -reconfigure
      
      - name: Import Existing Resources
        continue-on-error: true
        run: |
          echo "Importing existing AWS resources into fresh state..."
          
          # Import VPC and networking
          terraform import 'module.vpc.aws_vpc.main' $(aws ec2 describe-vpcs --filters "Name=tag:Name,Values=sweetdream-vpc" --query 'Vpcs[0].VpcId' --output text) || true
          
          # Import ALB
          terraform import 'module.alb.aws_lb.main' $(aws elbv2 describe-load-balancers --names sweetdream-alb --query 'LoadBalancers[0].LoadBalancerArn' --output text) || true
          terraform import 'module.alb.aws_lb_target_group.backend' $(aws elbv2 describe-target-groups --names sweetdream-backend-tg --query 'TargetGroups[0].TargetGroupArn' --output text) || true
          terraform import 'module.alb.aws_lb_target_group.frontend' $(aws elbv2 describe-target-groups --names sweetdream-frontend-tg --query 'TargetGroups[0].TargetGroupArn' --output text) || true
          
          # Import IAM roles
          terraform import 'module.iam.aws_iam_role.ecs_execution' sweetdream-ecs-execution-role || true
          terraform import 'module.iam.aws_iam_role.ecs_task' sweetdream-ecs-task-role || true
          
          # Import S3 buckets
          terraform import 'module.s3.aws_s3_bucket.logs' sweetdream-logs-data || true
          terraform import 'module.backend_analytics[0].aws_s3_bucket.analytics' sweetdream-analytics-backend-production || true
          terraform import 'module.order_analytics[0].aws_s3_bucket.analytics' sweetdream-analytics-order-production || true
          
          # Import RDS
          terraform import 'module.rds.aws_db_subnet_group.main' sweetdream-db-subnet-group || true
          
          # Import Secrets Manager
          terraform import 'module.secrets_manager.aws_secretsmanager_secret.db_credentials' sweetdream-db-secret || true
          
          echo "âœ“ Import completed" >> $GITHUB_STEP_SUMMARY
      
      - name: Terraform Plan
        run: |
          echo "Running Terraform plan..."
          terraform plan -var="db_password=${{ secrets.DB_PASSWORD }}" -out=tfplan
          
          echo ""
          echo "Plan summary:"
          terraform show -json tfplan | jq -r '.resource_changes[] | select(.change.actions != ["no-op"]) | "\(.change.actions[0]): \(.address)"'
      
      - name: Terraform Apply
        run: |
          echo "Applying Terraform changes..."
          terraform apply -auto-approve tfplan
          
          echo ""
          echo "âœ“ Infrastructure deployed" >> $GITHUB_STEP_SUMMARY
          
          # Verify bastion was created
          if terraform state list | grep -q "module.bastion"; then
            echo "âœ“ Bastion module deployed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš  Bastion module NOT in state" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Verify Lambda was created
          if terraform state list | grep -q "module.backend_analytics.*lambda"; then
            echo "âœ“ Analytics Lambda deployed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš  Analytics Lambda NOT in state" >> $GITHUB_STEP_SUMMARY
          fi

  # Build and deploy all services
  deploy-services:
    name: Deploy All Services
    needs: [deploy-infrastructure]
    if: always() && !cancelled() && needs.deploy-infrastructure.result == 'success'
    runs-on: ubuntu-latest
    environment: ${{ (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && 'production' || 'development' }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - uses: aws-actions/amazon-ecr-login@v2
        id: ecr
      
      - name: Get ALB URL
        id: alb
        run: |
          ALB_URL=$(aws elbv2 describe-load-balancers \
            --query 'LoadBalancers[?contains(LoadBalancerName, `sweetdream`)].DNSName' \
            --output text)
          echo "url=$ALB_URL" >> $GITHUB_OUTPUT
      
      - name: Build & Push All Images
        env:
          ECR_REGISTRY: ${{ steps.ecr.outputs.registry }}
          NEXT_PUBLIC_API_URL: http://${{ steps.alb.outputs.url }}
        run: |
          echo "Building all Docker images..."
          
          # Backend
          docker build -t $ECR_REGISTRY/sweetdream-backend:latest ./be
          docker push $ECR_REGISTRY/sweetdream-backend:latest
          echo "Backend pushed"
          
          # Frontend
          docker build --build-arg NEXT_PUBLIC_API_URL=$NEXT_PUBLIC_API_URL \
            -t $ECR_REGISTRY/sweetdream-frontend:latest ./fe
          docker push $ECR_REGISTRY/sweetdream-frontend:latest
          echo "Frontend pushed"
          
          # Order Service
          docker build -t $ECR_REGISTRY/sweetdream-order-service:latest ./order-service
          docker push $ECR_REGISTRY/sweetdream-order-service:latest
          echo "Order Service pushed"
          
          # User Service
          docker build -t $ECR_REGISTRY/sweetdream-user-service:latest ./user-service
          docker push $ECR_REGISTRY/sweetdream-user-service:latest
          echo "User Service pushed"
      
      - name: Deploy All Services to ECS
        run: |
          echo "ðŸš€ Deploying all services..."
          
          services=(
            "sweetdream-service-backend"
            "sweetdream-service-frontend"
            "sweetdream-service-order-service"
            "sweetdream-service-user-service"
          )
          
          for service in "${services[@]}"; do
            echo "Deploying: $service"
            aws ecs update-service \
              --cluster ${{ env.ECS_CLUSTER }} \
              --service $service \
              --force-new-deployment \
              --no-cli-pager || echo "Service $service not ready yet"
          done
          
          echo "All services deployed" >> $GITHUB_STEP_SUMMARY

  # Summary
  summary:
    name: Deployment Summary
    needs: [deploy-infrastructure, deploy-services]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Get Info
        id: info
        run: |
          ALB_URL=$(aws elbv2 describe-load-balancers \
            --query 'LoadBalancers[?contains(LoadBalancerName, `sweetdream`)].DNSName' \
            --output text)
          echo "alb_url=$ALB_URL" >> $GITHUB_OUTPUT
      
      - name: Create Summary
        run: |
          echo "## ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Status" >> $GITHUB_STEP_SUMMARY
          echo "- Infrastructure: ${{ needs.deploy-infrastructure.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Services: ${{ needs.deploy-services.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ Access" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: http://${{ steps.info.outputs.alb_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
